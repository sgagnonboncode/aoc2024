from enum import Enum
from functools import cache
from itertools import repeat
from typing import Tuple
from src.common.file_utils import read_lines
import re
from pydantic import BaseModel
import concurrent.futures

# input
MAPSIZE_X = 101
MAPSIZE_Y = 103

# example
# MAPSIZE_X = 11
# MAPSIZE_Y = 7


class RobotState(BaseModel):
    px: int = 0
    py: int = 0
    vx: int = 0
    vy: int = 0

    def animate(self):
        self.px += self.vx
        self.py += self.vy

        while self.px < 0:
            self.px += MAPSIZE_X

        while self.px >= MAPSIZE_X:
            self.px -= MAPSIZE_X

        while self.py < 0:
            self.py += MAPSIZE_Y

        while self.py >= MAPSIZE_Y:
            self.py -= MAPSIZE_Y


def parse_input(input: list[str]) -> list[RobotState]:

    robots: list[RobotState] = []

    for i in range(len(input)):
        numbers = [int(n) for n in re.findall(r"-?\d+", input[i])]

        if len(numbers) == 4:
            robot = RobotState(
                px=numbers[0], py=numbers[1], vx=numbers[2], vy=numbers[3]
            )
            robots.append(robot)

    return robots


def calculate_safety_factor(robots: list[RobotState]) -> int:
    # count number of robots in each quadrants
    tl = 0
    tr = 0
    bl = 0
    br = 0

    for robot in robots:
        if robot.px < MAPSIZE_X // 2 and robot.py < MAPSIZE_Y // 2:
            tl += 1
        elif robot.px > MAPSIZE_X // 2 and robot.py < MAPSIZE_Y // 2:
            tr += 1
        elif robot.px < MAPSIZE_X // 2 and robot.py > MAPSIZE_Y // 2:
            bl += 1
        elif robot.px > MAPSIZE_X // 2 and robot.py > MAPSIZE_Y // 2:
            br += 1

    print("TL:", tl, "TR:", tr, "BL:", bl, "BR:", br, "TOTAL:", tl * tr * bl * br)

    return tl * tr * bl * br


def solve_part1() -> int:
    # 228690000

    # input = read_lines("input/day14/example.txt")
    input = read_lines("input/day14/part1.txt")
    robots = parse_input(input)

    for i in range(1, 101):
        for robot in robots:
            robot.animate()

    return calculate_safety_factor(robots)


def print_map(robots: list[RobotState]):
    robot_map = [[0 for x in repeat(None, MAPSIZE_X)] for y in repeat(None, MAPSIZE_Y)]

    for robot in robots:
        robot_map[robot.py][robot.px] += 1

    for y in range(MAPSIZE_Y):
        for x in range(MAPSIZE_X):
            if robot_map[y][x] > 0:
                print(f"{robot_map[y][x]}", end="")
            else:
                print(".", end="")
        print()
    print()


def test_easter_egg(robots: list[RobotState]) -> bool:

    unique_positions = set()
    for robot in robots:
        unique_positions.add((robot.px, robot.py))

    return len(unique_positions) == len(robots)


def solve_part2() -> int:
    # input = read_lines("input/day14/example.txt")

    input = read_lines("input/day14/part1.txt")
    robots = parse_input(input)

    i = 0
    while not test_easter_egg(robots):
        i += 1

        if i % 1000 == 0:
            print(f"... {i} ...")

        for robot in robots:
            robot.animate()

        robot_map = [
            [0 for x in repeat(None, MAPSIZE_X)] for y in repeat(None, MAPSIZE_Y)
        ]

        for robot in robots:
            robot_map[robot.py][robot.px] += 1

    print(f"AFTER {i} STEPS")
    print_map(robots)

    return i


# Picture of the easter egg
# .........................1...........................................................................
# ..............................1......................................................................
# .....................................................................................1.........1.....
# ..............................................1.........................................1............
# .....................................................................................................
# .1.............1.....................................................................................
# .....................................................................................................
# ......1.....1.......................................................1...................1............
# 1.........................................................................1..........................
# ..........................................1..........................................................
# .....................................................................................................
# ..............................................................................1................1.....
# ................................1...1...............1..............................1.................
# ....................1................................................................................
# .......................1........................................................1....................
# ...........1...........1.....................1.......................................................
# ...................................................1..........1......................................
# ..................1...........1...................................................................1..
# .....................................................................................................
# .................1...........................1.......................................................
# ................1..1................................1................................................
# .....................................................................................................
# .....................................................................................................
# ............................1.1.....1111111111111111111111111111111..................................
# .1..................................1.............................1..................................
# ....................................1.............................1..................................
# ...1................................1.............................1..........................1.......
# ..........................1.........1.............................1...................1..............
# ....................................1..............1..............1..................................
# ...............................1....1.............111.............1..................................
# ....................................1............11111............1..................................
# ....................................1...........1111111...........1......................1........1..
# ....................................1..........111111111..........1............1................1....
# ....................................1............11111............1........1.........................
# ....................................1...........1111111...........1..................................
# .....................1............1.1..........111111111..........1.1............................1...
# ....................................1.........11111111111.........1..................................
# ....................................1........1111111111111........1..................................
# ....................................1..........111111111..........1.1..................11............
# ....................................1.........11111111111.........1..................................
# ....................................1........1111111111111........1..................................
# ......................1.............1.......111111111111111.......1..................................
# .......1............................1......11111111111111111......1..................................
# ...........1..1.....................1........1111111111111........1................1.................
# ....................................1.......111111111111111.......1...........................1......
# ....................................1......11111111111111111......1.....1.................1..........
# ......1.............................1.....1111111111111111111.....1..........1.......................
# ................1...................1....111111111111111111111....1...................1..............
# ..................................1.1.............111.............1..................................
# ....................................1.............111.............1......1...........................
# ....................................1.............111.............1..................................
# ....................................1.............................1..................................
# ............................1.......1.............................1..................................
# ....................................1.............................1..................................
# ...............1....................1.............................1..............1...................
# ..............1.........1...........1111111111111111111111111111111.....................1............
# ...........................1........................................1................................
# ....................1.....1................1..........................1..............................
# ............................1........................................................................
# ...............................................................................................1.....
# .........................1......................................1....................................
# .........................................................................1...1.......................
# ............................................1........................................................
# .............................................................................1........1..............
# .....................................................................................................
# .....................................................................................................
# ...1............................................1..............1.....................................
# .....................................................................................................
# .....................................................................................................
# ....................................................................................1............1...
# ..................................................................1..................................
# ................................1.......................1............................................
# .....................................................................................................
# ......................1..............................................................................
# ..............................1............1.........................................................
# ..............................................................1......................................
# ................................................................1....................................
# ......................................1............................1....................1............
# .....................................................................................................
# .....................................................................................................
# .........................................................................1....................1......
# ....................................1.......1............1.......1.........................1.........
# .....................................................................................................
# ...................................1................................1................................
# ..........................................................................1..........................
# .....................................................................1.........1.................1...
# ........................................1...........1...................1............................
# .................................................................1....1..............................
# ...........................................1.........................................................
# .....................................................................................................
# .1....1............................................................................1.................
# .........................................................1...........................................
# ..........................................................................................1..........
# ...................................1........................................................1........
# ........................1......................................1..........................1.1........
# .......1..................................................................1.........................1
# .....................................................................................................
# .....................................................................................................
# ..................................................................1................................1.
# .........................................................................1...........................
# ..........................1..........................................................................
# .................................................................1...................................
# ...........1.........................................................................................
